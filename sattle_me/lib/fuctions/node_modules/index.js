const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.deleteExpiredRideRequests = functions.pubsub
  .schedule('every 15 minutes')
  .onRun(async (context) => {
    const now = admin.firestore.Timestamp.now();
    // Set cutoff to one hour from now.
    const cutoffMillis = now.toMillis() + 60 * 60 * 1000;
    const cutoff = admin.firestore.Timestamp.fromMillis(cutoffMillis);
    
    // Query rideRequests where rideTime is less than or equal to the cutoff.
    const querySnapshot = await admin.firestore()
      .collection('rideRequests')
      .where('rideTime', '<=', cutoff)
      .get();
    
    // Batch delete expired ride requests.
    const batch = admin.firestore().batch();
    querySnapshot.forEach((doc) => {
      batch.delete(doc.ref);
    });
    
    await batch.commit();
    console.log(`Deleted ${querySnapshot.size} expired ride requests.`);
    return null;
  });
